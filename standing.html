<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Standings | MadridForID</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="icon" href="https://i.postimg.cc/J0krHM4b/1000089950-removebg-preview-2.png">
<style>
:root{--gold:#ffd700;--navy:#0b1d3a;--navy-soft:#09152e;--gray:#1a2238;--white:#fff;--muted:#c8c8d0;--danger:#e63946}
*{box-sizing:border-box;margin:0;padding:0}body{font-family:"Poppins",sans-serif;background:linear-gradient(180deg,var(--navy),var(--navy-soft));color:var(--muted);min-height:100vh;overflow-x:hidden}
.container{max-width:950px;margin:0 auto;padding:20px}.header-space{height:72px}
.page-title{font-size:1.6rem;font-weight:800;color:var(--white);margin-bottom:12px}
.controls{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.league-btn{background:var(--gold);border:0;color:#000;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
.sync-btn{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--white);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;display:none}
.last-upd{color:var(--muted);font-size:.95rem}
.table-wrap{background:rgba(255,255,255,0.03);padding:14px;border-radius:12px;margin-top:8px}
table{width:100%;border-collapse:collapse}
thead th{padding:12px;text-align:center;background:rgba(255,255,255,0.06);color:var(--muted);font-weight:700}
tbody td{padding:10px;text-align:center;color:var(--muted)}
tbody tr:nth-child(even){background:rgba(255,255,255,0.02)}
tbody td.team{text-align:left;color:var(--white);font-weight:600}
#toggleTable{margin-top:12px;width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.12);background:transparent;color:var(--gold);cursor:pointer}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:2200}
.modal-bg.show{display:flex}.modal{background:#fff;color:#000;width:90%;max-width:420px;padding:20px;border-radius:12px}
.opt{padding:12px;background:#eee;border-radius:8px;text-align:center;margin-top:10px;cursor:pointer;font-weight:700}
.opt:hover{background:var(--gold);color:#000}
@media (max-width:640px){.controls{flex-direction:column;align-items:flex-start}}
.error-msg{color:var(--danger);padding:18px;text-align:center}
</style>
</head>
<body>

<!-- header include -->
<div id="include-header"></div>
<div class="header-space"></div>

<div class="container">
  <h2 class="page-title">League Standings</h2>

  <div class="controls">
    <button id="chooseLeague" class="league-btn">Choose League</button>
    <button id="syncBtn" class="sync-btn" title="Sync from API (admin only)">Sync</button>
    <small id="lastUpdated" class="last-upd">Last updated: ‚Äî</small>
  </div>

  <div id="tableArea" class="table-wrap" aria-live="polite">
    <table>
      <thead>
        <tr>
          <th style="width:56px">#</th>
          <th style="text-align:left">Team</th>
          <th>P</th>
          <th>GD</th>
          <th>Pts</th>
        </tr>
      </thead>
      <tbody id="standBody">
        <tr><td colspan="5" style="color:var(--muted);text-align:center;padding:24px">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="errorBox" class="error-msg" style="display:none">Error loading standings.</div>

  <button id="toggleTable">Show All</button>
</div>

<!-- modal -->
<div id="leagueModal" class="modal-bg" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Choose league">
    <strong style="display:block;margin-bottom:8px">Select League</strong>
    <div class="opt" data-league="laliga">üá™üá∏ La Liga</div>
    <div class="opt" data-league="ucl">‚≠ê Champions League</div>
    <div class="opt" data-league="copa">üèÜ Copa del Rey</div>
  </div>
</div>

<script type="module">
/* ---------- CONFIG ---------- */
const API_BASE = "https://madridforid-api.vercel.app";
const DEFAULT_LEAGUE = "laliga";

/* ---------- header inject (strip scripts) ---------- */
(async ()=>{
  try{
    const res = await fetch("header.html?cb="+Date.now());
    const html = await res.text();
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    tmp.querySelectorAll("script").forEach(s=>s.remove());
    document.getElementById("include-header").innerHTML = tmp.innerHTML;

    // restore basic header interactions (if header has burger & mobile)
    const burger = document.getElementById("burgerBtn");
    const mobile = document.getElementById("mobileDropdown");
    if(burger && mobile){
      burger.addEventListener("click", ()=> mobile.classList.toggle("show"));
      document.addEventListener("click", (e)=>{
        if(!mobile.contains(e.target) && !burger.contains(e.target)) mobile.classList.remove("show");
      });
    }
    window.dispatchEvent(new Event("header-ready"));
  }catch(err){
    console.error("header load error", err);
    window.dispatchEvent(new Event("header-ready"));
  }
})();

/* ---------- DOM ---------- */
const tbody = document.getElementById("standBody");
const toggleBtn = document.getElementById("toggleTable");
const chooseLeague = document.getElementById("chooseLeague");
const leagueModal = document.getElementById("leagueModal");
const lastUpdated = document.getElementById("lastUpdated");
const errorBox = document.getElementById("errorBox");
const syncBtn = document.getElementById("syncBtn");

let currentLeague = DEFAULT_LEAGUE;
let fullRows = [];
let showingAll = false;

/* ---------- helpers ---------- */
function escapeHtml(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;"); }
function renderRows(rows){
  if(!rows || rows.length === 0){
    tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted);text-align:center;padding:18px">No data</td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map(r=>`
    <tr>
      <td style="font-weight:700">${escapeHtml(String(r.pos||""))}</td>
      <td class="team">${escapeHtml(r.team||"")}</td>
      <td>${escapeHtml(String(r.played ?? r.p ?? "-"))}</td>
      <td>${escapeHtml(String(r.gd ?? "-"))}</td>
      <td style="font-weight:800">${escapeHtml(String(r.pts ?? "-"))}</td>
    </tr>
  `).join("");
}

/* ---------- load from vercel api ---------- */
async function loadStandings(league){
  errorBox.style.display="none";
  tbody.innerHTML = `<tr><td colspan="5" style="color:var(--muted);text-align:center;padding:18px">Loading...</td></tr>`;
  showingAll=false; toggleBtn.textContent="Show All";

  try{
    const url = `${API_BASE}/api/standings?league=${league}`;
const resp = await fetch(url, { cache: "no-store" });
    if(!resp.ok){
      const txt = await resp.text();
      throw new Error(`API ${resp.status}: ${txt}`);
    }
    const data = await resp.json();
    if(!data || !data.rows) throw new Error("Invalid API response");

    fullRows = data.rows.map((r,i)=>({
      pos: r.pos ?? (i+1),
      team: r.team,
      played: r.played ?? r.p,
      gd: r.gd,
      pts: r.pts ?? r.points
    }));

    // default show top 5 (or all if less)
    renderRows(fullRows.slice(0, Math.min(5, fullRows.length)));
    lastUpdated.textContent = "Last updated: " + (data.updated || data.updatedAt || new Date().toISOString());
    // if less than 5, hide toggle
    if(fullRows.length <= 5) toggleBtn.style.display = "none";
    else toggleBtn.style.display = "block";
  }catch(err){
    console.error("loadStandings failed", err);
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:18px;color:var(--muted)">‚Äî</td></tr>`;
    errorBox.style.display="block";
    lastUpdated.textContent = "Last updated: ‚Äî";
  }
}

/* ---------- toggle show all ---------- */
toggleBtn.addEventListener("click", ()=> {
  if(showingAll){
    renderRows(fullRows.slice(0, Math.min(5, fullRows.length)));
    toggleBtn.textContent="Show All";
    showingAll=false;
  } else {
    renderRows(fullRows);
    toggleBtn.textContent="Show Less";
    showingAll=true;
  }
});

/* ---------- modal ---------- */
chooseLeague.addEventListener("click", ()=> {
  leagueModal.classList.add("show");
  leagueModal.setAttribute("aria-hidden","false");
});
leagueModal.addEventListener("click", (e)=> {
  if(e.target === leagueModal){
    leagueModal.classList.remove("show");
    leagueModal.setAttribute("aria-hidden","true");
  }
});
document.querySelectorAll("#leagueModal .opt").forEach(o=>{
  o.addEventListener("click", ()=>{
    currentLeague = o.dataset.league;
    chooseLeague.textContent = o.textContent + " ‚ñæ";
    leagueModal.classList.remove("show");
    leagueModal.setAttribute("aria-hidden","true");
    loadStandings(currentLeague);
  });
});

/* ---------- start ---------- */
window.addEventListener("header-ready", ()=> {
  const label = { laliga:"üá™üá∏ La Liga", ucl:"‚≠ê Champions League", copa:"üèÜ Copa del Rey" }[currentLeague] || "Choose League";
  chooseLeague.textContent = label + " ‚ñæ";
  loadStandings(currentLeague);
});

// fallback
setTimeout(()=>{ if(!tbody.innerHTML.trim()) loadStandings(currentLeague); }, 800);

</script>
</body>
</html>