<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MadridForID | Schedule Detail</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --gold:#ffd700;
      --navy:#0b1d3a;
      --gray:#1a2238;
      --white:#ffffff;
      --red:#e63946;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:"Poppins",sans-serif;
      background:linear-gradient(180deg,#0b1d3a,#10254d);
      color:#fff;
      min-height:100vh;
    }
    main{
      max-width:900px;
      margin:30px auto;
      padding:20px;
    }
    .flyer-box{
      background:var(--gray);
      padding:10px;
      border-radius:12px;
      margin-bottom:20px;
      border:2px solid var(--gold);
      text-align:center;
    }
    .flyer-box img{width:100%;border-radius:10px;}
    .schedule-card{
      background:var(--gray);
      padding:20px;
      border-radius:12px;
      margin-bottom:20px;
      text-align:center;
    }
    .status-btn{
      padding:6px 18px;
      border-radius:8px;
      font-weight:700;
      display:inline-block;
      margin-top:8px;
      background:var(--gold);
      color:#000;
    }
    .status-finished{
      background:rgba(255,255,255,.2);
      color:#ddd;
    }
    .article-box{
      background:var(--gray);
      padding:20px;
      border-radius:12px;
      margin-bottom:30px;
    }
    footer{
      text-align:center;
      padding:20px;
      background:#0b1d3a;
      margin-top:40px;
    }
    .back-btn{
      background:var(--gold);color:#000;
      padding:8px 14px;border-radius:8px;
      font-weight:700;text-decoration:none;
    }
    .delete-btn{
      background:var(--red);color:#fff;
      padding:8px 14px;border-radius:8px;
      font-weight:700;border:none;
      display:none;
    }
  </style>
</head>

<body>

<div id="include-header"></div>

<main>
  <div id="flyerBox" class="flyer-box"><p>Loading flyer...</p></div>

  <div class="schedule-card">
    <h2 id="matchTitle">Loading...</h2>
    <p id="matchStadium"></p>
    <p id="matchDate"></p>
    <p id="matchTime"></p>
    <p id="matchScore"></p>
    <span id="matchStatus" class="status-btn"></span>
  </div>

  <div class="article-box">
    <h3>üîç Sorotan Utama</h3>
    <p id="article">Loading article...</p>
  </div>

  <div style="text-align:center;margin-bottom:40px;">
    <a href="schedule.html" class="back-btn">‚Üê Back</a>
    <button id="deleteBtn" class="delete-btn">üóë Delete</button>
  </div>
</main>

<footer>¬© 2025 MadridForID</footer>

<script type="module">

/* ======================= FIREBASE INIT FIRST ======================= */
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import {
  getAuth, onAuthStateChanged, GoogleAuthProvider,
  signOut, signInWithPopup
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyA18AEH3-hByOQ7g9i3OJCJLzt4HDIJbpc",
  authDomain:"madridforid-web.firebaseapp.com",
  projectId:"madridforid-web",
  storageBucket:"madridforid-web.appspot.com",
  messagingSenderId:"882098167537",
  appId:"1:882098167537:web:acf50819e9c81adaad1350"
};

if (getApps().length === 0) initializeApp(firebaseConfig);

const db = getFirestore();
const auth = getAuth();
const provider = new GoogleAuthProvider();
const ADMIN_UID = "T9MBugPPYLQ4HVu6uLBV3kEck3C2";

/* ======================= INJECT HEADER ======================= */
(async () => {
  const wrap = document.getElementById("include-header");
  const res = await fetch("header.html?cb=" + Date.now());
  const html = await res.text();

  const tmp = document.createElement("div");
  tmp.innerHTML = html;

  tmp.querySelectorAll("script").forEach(s => s.remove());
  wrap.innerHTML = tmp.innerHTML;

  window.dispatchEvent(new Event("header-ready"));
})();

/* ======================= AFTER HEADER READY ======================= */
window.addEventListener("header-ready", () => {

  /* --- re-bind header buttons --- */
  const signBtn = document.getElementById("signBtn");
  const signText = document.getElementById("signText");
  const avatar = document.getElementById("avatarImg");
  const burger = document.getElementById("burgerBtn");
  const mobile = document.getElementById("mobileDropdown");

  if (signBtn) {
    signBtn.onclick = async () => {
      if (auth.currentUser) await signOut(auth);
      else await signInWithPopup(auth, provider);
    };
  }

  if (burger && mobile) {
    burger.onclick = () => mobile.classList.toggle("show");
    document.addEventListener("click", e => {
      if (!mobile.contains(e.target) && !burger.contains(e.target))
        mobile.classList.remove("show");
    });
  }

  // logo ‚Üí home
  const logo = document.querySelector(".brand-title");
  if (logo) {
    logo.style.cursor = "pointer";
    logo.onclick = () => window.location.href = "index.html";
  }

  // auth update header
  onAuthStateChanged(auth, user => {
    if (signText) signText.textContent = user ? "Logout" : "Sign In";
    if (avatar) {
      if (user) { avatar.src = user.photoURL; avatar.style.display="block"; }
      else avatar.style.display="none";
    }
  });

  /* ================= LOAD DATA HERE (firebase sudah siap) ================= */
  loadSchedule();
});

/* ======================= LOAD SCHEDULE FUNCTION ======================= */
async function loadSchedule() {
  const id = new URLSearchParams(location.search).get("id");

  if (!id) {
    document.getElementById("flyerBox").innerHTML = `<p style="color:red">Invalid ID</p>`;
    return;
  }

  const snap = await getDoc(doc(db, "schedule", id));

  if (!snap.exists()) {
    document.getElementById("flyerBox").innerHTML = `<p style="color:red">Not Found</p>`;
    return;
  }

  const d = snap.data();

  document.getElementById("matchTitle").textContent   = d.match;
  document.getElementById("matchStadium").textContent = "üèü " + (d.stadium || "-");
  document.getElementById("matchScore").textContent   = "‚öΩ " + (d.score || "-");
  document.getElementById("article").textContent      = d.article || "-";

  const flyerBox = document.getElementById("flyerBox");
  flyerBox.innerHTML = d.flyerUrl ? `<img src="${d.flyerUrl}">`
                                  : `<p>No flyer available</p>`;

  const dt = new Date(d.datetime);
  document.getElementById("matchDate").textContent =
    "üìÖ " + dt.toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"});
  document.getElementById("matchTime").textContent =
    "‚è∞ " + dt.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}) + " WIB";

  const statusEl = document.getElementById("matchStatus");
  const now = Date.now();
  const end = dt.getTime() + 2*60*60*1000;

  if (now > end) {
    statusEl.textContent = "FINISHED";
    statusEl.classList.add("status-finished");
  } else if (now < dt.getTime()) {
    statusEl.textContent = "UPCOMING";
  } else {
    statusEl.textContent = "LIVE";
    statusEl.style.background = "#e63946";
    statusEl.style.color = "#fff";
  }

  const deleteBtn = document.getElementById("deleteBtn");
  onAuthStateChanged(auth, user => {
    if (user && user.uid === ADMIN_UID) {
      deleteBtn.style.display = "inline-block";
      deleteBtn.onclick = async () => {
        if (confirm("Delete this match?")) {
          await deleteDoc(doc(db, "schedule", id));
          alert("Deleted");
          location.href = "schedule.html";
        }
      };
    }
  });
}

</script>

</body>
</html>