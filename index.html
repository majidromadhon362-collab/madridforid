<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MadridForID | Home</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="icon" href="https://raw.githubusercontent.com/majidromadhon362-collab/madridforid-images/main/1000089950-removebg-preview%20(2).png">

<style>
:root {
  --gold:#FFD700;
  --navy:#0b1d3a;
  --gray:#1a2238;
  --white:#ffffff;
  --red:#e63946;
}

/* RESET */
html,body{
  margin:0;padding:0;overflow-x:hidden;
  font-family:"Poppins",sans-serif;
  background:linear-gradient(180deg,#0b1d3a,#09152e);
  color:var(--white);
}
.container{max-width:1200px;margin:auto;padding:20px;}

/* ---------- HERO INTRO ---------- */
.hero-card{
  background:var(--gray);
  padding:18px;
  border-radius:14px;
  box-shadow:0 6px 16px rgba(0,0,0,.35);
}
.hero-card h1{font-size:1.8rem;font-weight:800;margin-bottom:6px;}
.hero-card p{color:#c8c8d0;margin-bottom:14px;font-size:.95rem;}

.hero-btn-row{
  display:flex;align-items:center;gap:18px;
}
.btn-gold{
  background:var(--gold);color:#000;font-weight:700;
  padding:8px 16px;border-radius:8px;text-decoration:none;
}
.explore-link{
  color:#fff;font-size:1rem;font-weight:600;text-decoration:none;opacity:.85;
}

/* ---------- HERO SLIDESHOW ---------- */
.hero-slideshow{
  width:100%;margin-top:14px;
  border-radius:14px;overflow:hidden;
  aspect-ratio:16/9;background:#0a1222;
  position:relative;
}
.slide{
  position:absolute;inset:0;
  width:100%;height:100%;
  object-fit:cover;
  opacity:0;transform:scale(1.08);
  transition:opacity 1.1s ease,transform 3s ease;
}
.slide.active{opacity:1;transform:scale(1)}
#editHeroBtn{
  position:absolute;top:12px;left:12px;
  padding:6px 10px;border-radius:8px;border:none;
  background:rgba(0,0,0,.6);
  color:#fff;font-weight:700;cursor:pointer;z-index:20;
  display:none;
}

/* ---------- SECTION HEADER ---------- */
.section-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-top:32px;margin-bottom:14px;
}
.section-header h2{font-size:1.15rem;font-weight:700;}
.section-header a{
  text-decoration:none;font-weight:700;font-size:.9rem;
  color:var(--gold);
}

/* ---------- SCROLL LIST ---------- */
.h-scroll{
  display:flex;gap:16px;overflow-x:auto;padding-bottom:10px;
}
.h-scroll::-webkit-scrollbar{display:none;}

.card{
  background:var(--gray);
  min-width:260px;
  border-radius:14px;
  padding:12px;
  position:relative;
  box-shadow:0 6px 16px rgba(0,0,0,.35);
}
.card img{
  width:100%;
  aspect-ratio:16/9;
  border-radius:10px;
  object-fit:cover;
  margin-bottom:6px;
}
.btn-readmore{
  background:var(--gold);color:#000;padding:6px 12px;
  border-radius:8px;font-weight:700;font-size:.85rem;text-decoration:none;
}
.editScoreBtn{
  display:none;position:absolute;top:10px;right:10px;
  background:var(--gold);color:#000;border:none;
  padding:6px 8px;border-radius:6px;font-size:.7rem;cursor:pointer;
}

/* ---------- BADGES ---------- */
.upcoming-badge{
  background:var(--gold);color:#000;
  font-weight:700;font-size:.75rem;
  padding:4px 10px;border-radius:6px;
  display:inline-block;margin-bottom:6px;
}
.live-badge{
  background:#e63946;color:#fff;
  font-weight:700;font-size:.75rem;
  padding:4px 10px;border-radius:6px;
  display:inline-block;margin-bottom:6px;
}
.countdown{
  font-weight:700;
  color:var(--gold);
  margin:6px 0 10px;
}

/* ---------- FOOTER ---------- */
footer{
  background:var(--navy);
  padding:20px;text-align:center;margin-top:40px;
}

/* small responsive tweaks */
@media (max-width:520px){
  .hero-card h1{font-size:1.3rem}
  .card{min-width:220px}
}
</style>
</head>

<body>

<!-- HEADER (injected without scripts to avoid double init) -->
<div id="include-header"></div>

<main class="container">

<!-- HERO -->
<div class="hero-card">
  <h1>Welcome to MadridForID</h1>
  <p>The digital community for Real Madrid fans in Indonesia â€” news, fixtures, standings, and more.</p>

  <div class="hero-btn-row">
    <a href="news.html" class="btn-gold">View News</a>
    <a href="#" class="explore-link">Explore</a>
  </div>

  <div class="hero-slideshow" id="heroWrap">
    <button id="editHeroBtn">âœŽ Edit Hero</button>
  </div>
</div>

<!-- RECENT RESULTS -->
<div class="section-header"><h2>âš½ Recent Results</h2></div>
<div id="recentBox" class="h-scroll" aria-live="polite"></div>

<!-- NEWS -->
<div class="section-header"><h2>ðŸ“° Latest News</h2><a href="news.html">View all</a></div>
<div id="newsBox" class="h-scroll" aria-live="polite"></div>

<!-- UPCOMING -->
<div class="section-header"><h2>ðŸ“… Upcoming Matches</h2><a href="schedule.html">View all</a></div>
<div id="upcomingBox" class="h-scroll" aria-live="polite"></div>

<!-- GALLERY -->
<div class="section-header"><h2>ðŸ“¸ Gallery</h2><a href="gallery.html">View all</a></div>
<div id="galleryBox" class="h-scroll" aria-live="polite"></div>

</main>

<footer>Â© 2025 MadridForID | Real Madrid Indonesia Fanbase</footer>

<!-- MAIN JS -->
<script type="module">
/* =======================
   FIREBASE + CONFIG
   ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, query, orderBy, limit
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const ADMIN_UID = "T9MBugPPYLQ4HVu6uLBV3kEck3C2";

const firebaseConfig = {
  apiKey:"AIzaSyA18AEH3-hByOQ7g9i3OJCJLzt4HDIJbpc",
  authDomain:"madridforid-web.firebaseapp.com",
  projectId:"madridforid-web",
  storageBucket:"madridforid-web.appspot.com",
  messagingSenderId:"882098167537",
  appId:"1:882098167537:web:acf50819e9c81adaad1350"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* =======================
   HEADER INJECTION (strip scripts)
   - This prevents double Firebase init from header module.
   - Then we wire burger + sign locally below.
   ======================= */
(async function injectHeaderStripScripts(){
  try{
    const target = document.getElementById("include-header");
    const res = await fetch("header.html?cb=" + Date.now());
    if(!res.ok){ target.innerHTML=""; window.dispatchEvent(new Event("header-ready")); return; }
    const html = await res.text();

    const tmp = document.createElement("div");
    tmp.innerHTML = html;

    // remove module scripts so header won't re-init firebase
    tmp.querySelectorAll("script").forEach(s=>s.remove());
    target.innerHTML = tmp.innerHTML;

    // local wiring for burger & sign (header scriptless)
    const burger = document.getElementById("burgerBtn");
    const mobile = document.getElementById("mobileDropdown");
    const signBtn = document.getElementById("signBtn");
    const signText = document.getElementById("signText");
    const avatarImg = document.getElementById("avatarImg");

    // burger toggle
    burger?.addEventListener("click", ()=> mobile.classList.toggle("show"));
    document.addEventListener("click", (e)=>{
      if(!mobile || !burger) return;
      if(!mobile.contains(e.target) && !burger.contains(e.target)) mobile.classList.remove("show");
    });

    // sign in/out local handler
    signBtn?.addEventListener("click", async ()=>{
      if(auth.currentUser) await signOut(auth);
      else await signInWithPopup(auth, provider);
    });

    // signal ready
    window.dispatchEvent(new Event("header-ready"));
  }catch(err){
    console.error("header inject failed", err);
    window.dispatchEvent(new Event("header-ready"));
  }
})();

/* =======================
   FAST PARALLEL LOAD
   ======================= */
async function loadAll(){
  const heroWrap = document.getElementById("heroWrap");
  const newsBox = document.getElementById("newsBox");
  const upcomingBox = document.getElementById("upcomingBox");
  const recentBox = document.getElementById("recentBox");
  const galleryBox = document.getElementById("galleryBox");

  // show quick placeholders
  newsBox.innerHTML = `<div class="card" style="min-width:200px;padding:12px;color:#bbb;">Loading news...</div>`;
  upcomingBox.innerHTML = `<div class="card" style="min-width:200px;padding:12px;color:#bbb;">Loading schedule...</div>`;
  recentBox.innerHTML = `<div class="card" style="min-width:200px;padding:12px;color:#bbb;">Loading results...</div>`;
  galleryBox.innerHTML = `<div class="card" style="min-width:200px;padding:12px;color:#bbb;">Loading gallery...</div>`;

  // prepare queries (fire in parallel)
  const qHero   = getDocs(collection(db,"home_hero"));
  const qNews   = getDocs(query(collection(db,"news"), orderBy("createdAt","desc"), limit(8)));
  const qSched  = getDocs(query(collection(db,"schedule"), orderBy("datetime","asc"), limit(50)));
  const qGallery= getDocs(query(collection(db,"gallery"), orderBy("createdAt","desc"), limit(12)));

  const [heroSnap, newsSnap, schedSnap, gallerySnap] = await Promise.all([qHero, qNews, qSched, qGallery]);

  /* ---------- HERO ---------- */
  (function renderHero(){
    heroWrap.innerHTML = `<button id="editHeroBtn" style="display:none;">âœŽ Edit Hero</button>`;
    const urls = [];
    heroSnap.forEach(d=>{ const data = d.data(); if(data && data.url) urls.push(data.url); });
    if(urls.length===0) return;
    urls.forEach((url,i)=>{
      const img = document.createElement("img");
      img.className = "slide";
      img.src = url;
      img.loading = "lazy";
      img.alt = "hero";
      heroWrap.appendChild(img);
    });
    const slides = heroWrap.querySelectorAll(".slide");
    if(slides.length===0) return;
    slides[0].classList.add("active");
    let idx = 0;
    setInterval(()=>{
      slides[idx].classList.remove("active");
      idx = (idx+1) % slides.length;
      slides[idx].classList.add("active");
    }, 4000);
  })();

  /* ---------- NEWS ---------- */
  (function renderNews(){
    newsBox.innerHTML = "";
    const frag = document.createDocumentFragment();
    newsSnap.forEach(doc=>{
      const d = doc.data();
      const card = document.createElement("div");
      card.className = "card";
      const img = document.createElement("img");
      img.src = d.image || "https://raw.githubusercontent.com/majidromadhon362-collab/madridforid-images/main/1000089950-removebg-preview%20(2).png";
      img.loading = "lazy";
      img.alt = d.title || "news";
      const h4 = document.createElement("h4");
      h4.style = "white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
      h4.textContent = d.title || "Untitled";
      const a = document.createElement("a");
      a.className = "btn-readmore";
      a.href = `news-detail.html?id=${doc.id}`;
      a.textContent = "Read More";

      card.appendChild(img);
      card.appendChild(h4);
      card.appendChild(a);
      frag.appendChild(card);
    });
    newsBox.appendChild(frag);
  })();

  /* ---------- SCHEDULE (recent + upcoming) ---------- */
  (function renderSchedule(){
    const now = Date.now();
    recentBox.innerHTML = "";
    upcomingBox.innerHTML = "";
    const recentFrag = document.createDocumentFragment();
    const upcomingFrag = document.createDocumentFragment();

    schedSnap.forEach(doc=>{
      const d = doc.data();
      const dt = new Date(d.datetime).getTime();
      const end = dt + (2*60*60*1000);
      const isFinished = now > end;
      const isLive = now >= dt && now <= end;
      const isUpcoming = dt > now;

      const card = document.createElement("div");
      card.className = "card";

      // image
      const img = document.createElement("img");
      img.src = d.flyerUrl || d.flyer || (d.image) || "https://raw.githubusercontent.com/majidromadhon362-collab/madridforid-images/main/1000089950-removebg-preview%20(2).png";
      img.loading = "lazy";
      img.alt = d.match || "match";

      // title
      const title = document.createElement("h4");
      title.style = "white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
      title.textContent = d.match || "Match";

      // meta & read
      const small = document.createElement("small");
      small.textContent = new Date(dt).toLocaleString("id-ID");

      const scoreDiv = document.createElement("div");
      scoreDiv.style = "font-weight:700;color:var(--gold);margin:6px 0";
      scoreDiv.textContent = d.score || "- : -";

      const read = document.createElement("a");
      read.className = "btn-readmore";
      read.href = `schedule-detail.html?id=${doc.id}`;
      read.textContent = "Read More";

      // append elements
      card.appendChild(img);
      card.appendChild(title);
      card.appendChild(small);

      if(isFinished){
        card.appendChild(scoreDiv);
        const editBtn = document.createElement("button");
        editBtn.className = "editScoreBtn";
        editBtn.dataset.id = doc.id;
        editBtn.textContent = "Edit";
        card.appendChild(editBtn);
        recentFrag.appendChild(card);
      } else {
        if(isLive){
          const liveBadge = document.createElement("span");
          liveBadge.className = "live-badge";
          liveBadge.textContent = "LIVE ðŸ”´";
          card.insertBefore(liveBadge, img);
          card.appendChild(read);
          upcomingFrag.appendChild(card);
        } else if(isUpcoming){
          const upBadge = document.createElement("span");
          upBadge.className = "upcoming-badge";
          upBadge.textContent = "UPCOMING";
          card.insertBefore(upBadge, img);

          // countdown small
          const diff = Math.max(0, dt - now);
          const days = Math.floor(diff / 86400000);
          const hrs = Math.floor((diff % 86400000) / 3600000);
          const mins = Math.floor((diff % 3600000) / 60000);
          const cd = document.createElement("div");
          cd.className = "countdown";
          cd.textContent = `â³ ${days}D ${hrs}H ${mins}M`;
          card.appendChild(cd);

          card.appendChild(read);
          upcomingFrag.appendChild(card);
        }
      }

    });

    recentBox.appendChild(recentFrag);
    upcomingBox.appendChild(upcomingFrag);
  })();

  /* ---------- GALLERY ---------- */
  (function renderGallery(){
    galleryBox.innerHTML = "";
    const frag = document.createDocumentFragment();
    gallerySnap.forEach(doc=>{
      const d = doc.data();
      const card = document.createElement("div");
      card.className = "card";
      const img = document.createElement("img");
      img.src = d.imageUrl || d.url || "https://raw.githubusercontent.com/majidromadhon362-collab/madridforid-images/main/1000089950-removebg-preview%20(2).png";
      img.loading = "lazy";
      img.alt = d.subtitle || "gallery";
      card.appendChild(img);
      frag.appendChild(card);
    });
    galleryBox.appendChild(frag);
  })();

  // After render, make sure admin buttons visibility is correct (auth may not be ready yet)
  // If auth already has user, show edit buttons
  const isAdminNow = auth.currentUser && auth.currentUser.uid === ADMIN_UID;
  document.querySelectorAll(".editScoreBtn").forEach(b=>b.style.display = isAdminNow ? "block" : "none");

  // attach click handler on edit buttons (delegated)
  document.querySelectorAll(".editScoreBtn").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const id = e.target.dataset.id;
      // open modal or navigate to schedule-detail with edit param
      window.location.href = `schedule-detail.html?id=${id}&edit=1`;
    });
  });

}

/* =======================
   AUTH STATE HANDLING
   - Update header UI (sign text + avatar)
   - Toggle admin buttons when auth changes
   ======================= */
onAuthStateChanged(auth, user=>{
  // update header UI if exists
  const signText = document.getElementById("signText");
  const avatarImg = document.getElementById("avatarImg");
  if(signText) signText.textContent = user ? "Logout" : "Sign In";
  if(avatarImg){
    if(user){ avatarImg.src = user.photoURL || ""; avatarImg.style.display = "block"; }
    else avatarImg.style.display = "none";
  }

  // toggle edit buttons (if present)
  const isAdmin = user && user.uid === ADMIN_UID;
  document.querySelectorAll(".editScoreBtn").forEach(btn=> btn.style.display = isAdmin ? "block" : "none");
});

/* =======================
   RUN when header ready
   - header-ready is dispatched by header injection above
   ======================= */
window.addEventListener("header-ready", ()=>{
  // load data
  loadAll().catch(err=>console.error("loadAll err",err));
});

/* Also fallback to DOMContentLoaded (just in case) */
document.addEventListener("DOMContentLoaded", ()=>{
  setTimeout(()=>{
    // if nothing loaded yet, try loading once
    const boxes = document.querySelectorAll("#newsBox .card, #upcomingBox .card, #galleryBox .card");
    if(boxes.length===0){
      loadAll().catch(err=>console.error("loadAll fallback err",err));
    }
  }, 600);
});

// ===== SHOW EDIT HERO IF ADMIN =====
onAuthStateChanged(auth, user=>{
  const editHeroBtn = document.getElementById("editHeroBtn");
  if(editHeroBtn){
    editHeroBtn.style.display = (user && user.uid === ADMIN_UID) ? "block" : "none";
  }
});
</script>

</body>
</html>