<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MadridForID | Gallery</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

  <style>
    :root {
      --gold:#ffd700;
      --navy:#001b4d;
      --dark:#0b1d3a;
      --red:#e63946;
      --white:#fff;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{
      font-family:"Poppins",sans-serif;
      background:linear-gradient(180deg,var(--dark),#0a1a38);
      color:var(--white);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }
    main{flex:1;width:100%;max-width:1100px;margin:auto;padding:20px}
    .top-row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:14px;gap:12px}
    .btn{background:var(--gold);color:#000;border:0;padding:8px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:2px solid var(--gold);color:var(--gold)}
    .category-select{position:relative}
    .select-display{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:6px 12px;cursor:pointer;color:#fff;min-width:180px;display:flex;justify-content:space-between;align-items:center}
    .select-options{position:absolute;top:105%;left:0;width:100%;background:#fff;color:#000;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);display:none;flex-direction:column;z-index:10}
    .select-options.show{display:flex}
    .select-options div{padding:8px 10px;cursor:pointer}
    .select-options div:hover{background:var(--gold);color:#000;font-weight:600}
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-top:20px}
    .card{background:rgba(255,255,255,0.05);border-radius:12px;overflow:hidden;transition:transform .18s;position:relative}
    .card:hover{transform:translateY(-5px)}
    .thumb{position:relative;padding-top:56.25%;overflow:hidden;background:#111}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transition:opacity .4s;opacity:0}
    .thumb img.loaded{opacity:1}
    .meta{text-align:center;padding:10px}
    .category{background:var(--gold);color:#000;padding:4px 10px;border-radius:999px;font-weight:700;font-size:.8rem}
    .delete-btn{background:var(--red);border:0;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;margin-top:6px}
    footer{background:var(--navy);text-align:center;padding:15px;font-size:.9rem;margin-top:auto}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;justify-content:center;align-items:center;z-index:1500}
    .overlay.show{display:flex}
    .form-card{background:#fff;color:#000;border-radius:12px;padding:20px;width:90%;max-width:600px}
    .form-group{margin-bottom:12px}
    .form-group label{font-weight:600;margin-bottom:6px;display:block}
    .form-group input{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
    #cropArea{display:none;margin-top:10px;max-height:350px;overflow:hidden;border-radius:8px}
    #cropArea img{width:100%;display:block}
  </style>
</head>

<body>

  <!-- HEADER -->
  <div id="include-header"></div>
  <script>
  (async()=>{
    const res = await fetch("header.html?cb=" + Date.now());
    const html = await res.text();
    const box = document.getElementById("include-header");
    box.innerHTML = html;
    box.querySelectorAll("script").forEach(old=>{
      const s=document.createElement("script");
      if(old.src) s.src=old.src;
      else s.textContent=old.textContent;
      document.body.appendChild(s);
    });
  })();
  </script>

  <main>
    <div class="top-row">
      <h2>ðŸ“¸ Gallery</h2>

      <div style="display:flex;gap:12px;align-items:center">
        <div class="category-select">
          <div id="selectDisplay" class="select-display">All categories â–¼</div>
          <div id="selectOptions" class="select-options">
            <div data-val="all">All categories</div>
            <div data-val="Matchday">Matchday</div>
            <div data-val="Training">Training</div>
            <div data-val="Press Conference">Press Conference</div>
            <div data-val="Celebration">Celebration</div>
            <div data-val="Other">Other</div>
          </div>
        </div>

        <button id="addBtn" class="btn" style="display:none;">ï¼‹ Add Photo</button>
      </div>
    </div>

    <div id="galleryGrid" class="gallery-grid"></div>
  </main>

  <!-- ADD PHOTO MODAL -->
  <div id="overlay" class="overlay">
    <div class="form-card">
      <h3 style="text-align:center;margin-bottom:10px;">ï¼‹ Add Photo</h3>

      <div class="form-group">
        <label>Category</label>
        <select id="catInput" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc">
          <option value="Matchday">Matchday</option>
          <option value="Training">Training</option>
          <option value="Press Conference">Press Conference</option>
          <option value="Celebration">Celebration</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label>Subtitle</label>
        <input id="subInput" placeholder="e.g. Modric training moment" />
      </div>

      <div class="form-group">
        <label>Upload Image</label>
        <input id="fileInput" type="file" accept="image/*" />
        <div id="cropArea"><img id="cropImg"></div>
        <button id="cropBtn" class="btn" style="display:none;margin-top:8px;">Crop (16:9)</button>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
        <button id="saveBtn" class="btn">Upload</button>
        <button onclick="overlay.classList.remove('show')" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>

  <footer>Â© 2025 MadridForID | Real Madrid Indonesia Fanbase</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <script type="module">
    // FIREBASE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // IMGBB
    const IMGBB_API_KEY = "c438ddf1b0de692e084414e335436ec6";

    const firebaseConfig = {
      apiKey:"AIzaSyA18AEH3-hByOQ7g9i3OJCJLzt4HDIJbpc",
      authDomain:"madridforid-web.firebaseapp.com",
      projectId:"madridforid-web",
      storageBucket:"madridforid-web.appspot.com",
      messagingSenderId:"882098167537",
      appId:"1:882098167537:web:acf50819e9c81adaad1350"
    };

    const ADMIN_UID = "T9MBugPPYLQ4HVu6uLBV3kEck3C2";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth= getAuth(app);

    // DOM
    const grid = document.getElementById("galleryGrid");
    const selectDisplay = document.getElementById("selectDisplay");
    const selectOptions = document.getElementById("selectOptions");
    const addBtn = document.getElementById("addBtn");
    const overlay = document.getElementById("overlay");

    const fileInput = document.getElementById("fileInput");
    const cropArea = document.getElementById("cropArea");
    const cropImg  = document.getElementById("cropImg");
    const cropBtn  = document.getElementById("cropBtn");
    const saveBtn  = document.getElementById("saveBtn");

    const catInput = document.getElementById("catInput");
    const subInput = document.getElementById("subInput");

    let currentUser = null;
    let currentCategory = "all";
    let cropper = null;

    // CATEGORY DROPDOWN
    selectDisplay.onclick=()=>selectOptions.classList.toggle("show");
    selectOptions.querySelectorAll("div").forEach(opt=>{
      opt.onclick=()=>{
        currentCategory = opt.dataset.val;
        selectDisplay.textContent = opt.textContent + " â–¼";
        selectOptions.classList.remove("show");
        loadGallery();
      };
    });

    // LOAD GALLERY
    async function loadGallery(){
      grid.innerHTML="<p style='color:#ccc;'>Loading...</p>";

      let q=(currentCategory!=="all")
        ? query(collection(db,"gallery"), where("category","==",currentCategory), orderBy("createdAt","desc"))
        : query(collection(db,"gallery"), orderBy("createdAt","desc"));

      const snap=await getDocs(q);
      grid.innerHTML="";

      if(snap.empty){
        grid.innerHTML="<p style='color:#bbb;'>No images found.</p>";
        return;
      }

      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const card = document.createElement("div");
        card.className="card";

        const img = document.createElement("img");
        img.src = d.imageUrl;
        img.onload = () => img.classList.add("loaded");

        card.innerHTML = `
          <div class='thumb'></div>
          <div class='meta'>
            <span class='category'>${d.category}</span>
            <p>${d.subtitle || ""}</p>
          </div>
        `;
        card.querySelector(".thumb").appendChild(img);

        if(currentUser && currentUser.uid === ADMIN_UID){
          const del = document.createElement("button");
          del.textContent="ðŸ—‘ Delete";
          del.className="delete-btn";
          del.onclick = async () => {
            if(confirm("Delete this photo?")){
              await deleteDoc(doc(db,"gallery",docSnap.id));
              loadGallery();
            }
          };
          card.appendChild(del);
        }

        grid.appendChild(card);
      });
    }

    // AUTH (Admin only button)
    onAuthStateChanged(auth,(u)=>{
      currentUser=u;
      addBtn.style.display = (u && u.uid===ADMIN_UID) ? "inline-block" : "none";
    });

    // OPEN OVERLAY
    addBtn.onclick = () => overlay.classList.add("show");

    // CROP HANDLER
    fileInput.onchange = e => {
      const file = e.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        cropImg.src = reader.result;
        cropArea.style.display="block";
        cropBtn.style.display="inline-block";

        cropper && cropper.destroy();
        cropper = new Cropper(cropImg,{
          aspectRatio:16/9,
          viewMode:1,
          autoCropArea:1
        });
      };
      reader.readAsDataURL(file);
    };

    cropBtn.onclick=()=>{
      const canvas = cropper.getCroppedCanvas({
        width:1600,
        height:900
      });
      cropImg.src = canvas.toDataURL("image/jpeg",0.9);
      cropBtn.style.display="none";
    };

    // SAVE PHOTO (Upload to IMGBB)
    saveBtn.onclick = async()=>{
      if(!cropImg.src) return alert("Upload image first!");

      saveBtn.textContent="Uploading...";
      saveBtn.disabled=true;

      // Convert base64 to blob
      const blob = await (await fetch(cropImg.src)).blob();

      const form = new FormData();
      form.append("key", IMGBB_API_KEY);
      form.append("image", blob);

      const res = await fetch("https://api.imgbb.com/1/upload", {
        method:"POST",
        body: form
      });

      const json = await res.json();
      if(!json.success){
        alert("Upload failed");
        saveBtn.disabled=false;
        saveBtn.textContent="Upload";
        return;
      }

      const imageURL = json.data.url;

      await addDoc(collection(db,"gallery"),{
        imageUrl: imageURL,
        subtitle: subInput.value || "",
        category: catInput.value,
        createdAt: serverTimestamp()
      });

      alert("Photo added!");

      overlay.classList.remove("show");
      cropArea.style.display="none";
      fileInput.value="";
      subInput.value="";

      saveBtn.disabled=false;
      saveBtn.textContent="Upload";

      loadGallery();
    };

    // FIRST LOAD
    loadGallery();
  </script>

</body>
</html>