<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MadridForID | Gallery</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

  <style>
    :root {
      --gold:#ffd700;
      --navy:#001b4d;
      --dark:#0b1d3a;
      --red:#e63946;
      --white:#fff;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{
      font-family:"Poppins",sans-serif;
      background:linear-gradient(180deg,var(--dark),#0a1a38);
      color:var(--white);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }

    main{flex:1;width:100%;max-width:1100px;margin:auto;padding:20px}

    .top-row{
      display:flex;justify-content:space-between;align-items:center;
      flex-wrap:wrap;margin-bottom:14px;gap:12px
    }

    .btn{
      background:var(--gold);color:#000;border:0;
      padding:8px 14px;border-radius:8px;font-weight:700;cursor:pointer
    }
    .btn.ghost{background:transparent;border:2px solid var(--gold);color:var(--gold)}

    /* SELECT */
    .category-select{position:relative}
    .select-display{
      background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
      border-radius:8px;padding:6px 12px;cursor:pointer;color:#fff;
      min-width:180px;display:flex;justify-content:space-between;align-items:center
    }
    .select-options{
      position:absolute;top:105%;left:0;width:100%;
      background:#fff;color:#000;border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.2);display:none;
      flex-direction:column;z-index:10
    }
    .select-options.show{display:flex}
    .select-options div{padding:8px 10px;cursor:pointer}
    .select-options div:hover{background:var(--gold);color:#000;font-weight:600}

    /* GRID */
    .gallery-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;margin-top:20px
    }
    .card{
      background:rgba(255,255,255,0.05);
      border-radius:12px;overflow:hidden;
      transition:transform .18s;position:relative;cursor:pointer;
    }
    .card:hover{transform:translateY(-5px)}

    .thumb{
      position:relative;padding-top:56.25%;overflow:hidden;background:#111;
    }
    .thumb img{
      position:absolute;inset:0;width:100%;height:100%;
      object-fit:cover;transition:opacity .3s;opacity:0
    }
    .thumb img.loaded{opacity:1}

    .meta{text-align:center;padding:10px}
    .category{
      background:var(--gold);color:#000;padding:4px 10px;
      border-radius:999px;font-weight:700;font-size:.8rem
    }
    .delete-btn{
      background:var(--red);border:0;color:#fff;
      padding:6px 10px;border-radius:8px;cursor:pointer;margin-top:6px
    }

    footer{
      background:var(--navy);text-align:center;padding:15px;
      font-size:.9rem;margin-top:auto
    }

    /* OVERLAY */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;justify-content:center;align-items:center;z-index:1500
    }
    .overlay.show{display:flex}

    .form-card{
      background:#fff;color:#000;border-radius:12px;
      padding:20px;width:90%;max-width:600px
    }
    .form-group{margin-bottom:12px}
    .form-group label{font-weight:600;margin-bottom:6px;display:block}
    .form-group input{
      width:100%;padding:8px;border:1px solid #ccc;border-radius:8px
    }

    #cropArea{display:none;margin-top:10px;max-height:350px;overflow:hidden;border-radius:8px}
    #cropArea img{width:100%;display:block}

    #errorMsg{
      color:#ff7676;
      margin-top:14px;
      font-weight:600;
    }
    
    /* ===== FULLSCREEN PREVIEW ===== */
    .gallery-preview-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      animation: fadeIn .2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; } 
      to { opacity: 1; }
    }

    .gallery-preview-card {
      position: relative;
      width: 90%;
      max-width: 900px;
      background: transparent;
      border-radius: 14px;
    }

    .gallery-preview-wrapper {
      width: 100%;
      padding-top: 56.25%; /* 16:9 */
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      background: #000;
    }

    .gallery-preview-img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .close-preview-btn {
      position: absolute;
      top: 14px;
      right: 14px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 6px 10px;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div id="include-header"></div>
  <script>
    (async()=>{
      const res = await fetch("header.html?cb="+Date.now());
      const html = await res.text();
      const box = document.getElementById("include-header");

      const tmp = document.createElement("div");
      tmp.innerHTML = html;

      // remove scripts (we wire header locally)
      tmp.querySelectorAll("script").forEach(s=>s.remove());
      box.innerHTML = tmp.innerHTML;

      // basic header wiring (burger/sign)
      const burger = document.getElementById("burgerBtn");
      const mobile = document.getElementById("mobileDropdown");
      const signBtn = document.getElementById("signBtn");
      const signText = document.getElementById("signText");
      const avatarImg = document.getElementById("avatarImg");

      burger?.addEventListener("click", ()=> mobile.classList.toggle("show"));
      document.addEventListener("click", (e)=>{
        if(!mobile) return;
        if(!mobile.contains(e.target) && !burger.contains(e.target))
          mobile.classList.remove("show");
      });

      window._headerReady = true;
      window.dispatchEvent(new Event("header-ready"));
    })();
  </script>

  <main>
    <div class="top-row">
      <h2>ðŸ“¸ Gallery</h2>

      <div style="display:flex;gap:12px;align-items:center">
        <div class="category-select">
          <div id="selectDisplay" class="select-display">All categories â–¼</div>
          <div id="selectOptions" class="select-options" role="listbox" tabindex="-1">
            <div data-val="all" role="option">All categories</div>
            <div data-val="Matchday" role="option">Matchday</div>
            <div data-val="Training" role="option">Training</div>
            <div data-val="Press Conference" role="option">Press Conference</div>
            <div data-val="Celebration" role="option">Celebration</div>
            <div data-val="Other" role="option">Other</div>
          </div>
        </div>

        <button id="addBtn" class="btn" style="display:none;">ï¼‹ Add Photo</button>
      </div>
    </div>

    <div id="errorMsg"></div>

    <div id="galleryGrid" class="gallery-grid" aria-live="polite"></div>

    <button id="loadMoreBtn"
      class="btn ghost"
      style="margin:25px auto;display:none;width:180px;">
      Load More â–¼
    </button>
  </main>

  <!-- ADD PHOTO MODAL -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="form-card" role="dialog" aria-modal="true" aria-labelledby="addPhotoTitle">
      <h3 id="addPhotoTitle" style="text-align:center;margin-bottom:10px;">ï¼‹ Add Photo</h3>

      <div class="form-group">
        <label>Category</label>
        <select id="catInput" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc">
          <option value="Matchday">Matchday</option>
          <option value="Training">Training</option>
          <option value="Press Conference">Press Conference</option>
          <option value="Celebration">Celebration</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label>Subtitle</label>
        <input id="subInput" placeholder="e.g. Modric training moment" />
      </div>

      <div class="form-group">
        <label>Upload Image</label>
        <input id="fileInput" type="file" accept="image/*" />
        <div id="cropArea"><img id="cropImg" alt="crop preview"></div>
        <button id="cropBtn" class="btn" style="display:none;margin-top:8px;">Crop (16:9)</button>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
        <button id="saveBtn" class="btn">Upload</button>
        <button id="cancelBtn" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- FULLSCREEN PHOTO PREVIEW -->
  <div id="galleryPreview" class="gallery-preview-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="gallery-preview-card">
      <div class="gallery-preview-wrapper">
        <img id="galleryPreviewImg" class="gallery-preview-img" src="" alt="Preview">
        <button id="closePreviewBtn" class="close-preview-btn" aria-label="Close preview">Close</button>
      </div>
    </div>
  </div>

  <footer>Â© 2025 MadridForID | Real Madrid Indonesia Fanbase</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  
  <script type="module">
/* ----------------------------- FIREBASE INIT ----------------------------- */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, query,
  orderBy, where, serverTimestamp, deleteDoc, doc, limit, startAfter
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const ADMIN_UID = "T9MBugPPYLQ4HVu6uLBV3kEck3C2";

/* GitHub Upload Config */
const GITHUB_OWNER = "majidromadhon362-collab";
const GITHUB_REPO  = "madridforid-images";
const GITHUB_BRANCH = "main";

const firebaseConfig = {
  apiKey: "AIzaSyA18AEH3-hByOQ7g9i3OJCJLzt4HDIJbpc",
  authDomain: "madridforid-web.firebaseapp.com",
  projectId: "madridforid-web",
  storageBucket: "madridforid-web.appspot.com",
  messagingSenderId: "882098167537",
  appId: "1:882098167537:web:acf50819e9c81adaad1350"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ------------------ FIX: HEADER SIGN IN/OUT 100% ------------------ */

window.addEventListener("header-ready", () => {
  const signBtn  = document.getElementById("signBtn");
  const signText = document.getElementById("signText");
  const avatarImg = document.getElementById("avatarImg");

  if (!signBtn) return;

  // Bind sign button
  signBtn.onclick = async () => {
    try {
      if (auth.currentUser) {
        await signOut(auth);
      } else {
        await signInWithPopup(auth, provider);
      }
    } catch (err) {
      console.error("Auth error:", err);
      alert("Sign In gagal: " + (err.message || err));
    }
  };

  // Update UI if user already logged in
  onAuthStateChanged(auth, (user) => {
    if (signText) {
      signText.textContent = user ? "Logout" : "Sign In";
    }
    if (avatarImg) {
      if (user) {
        avatarImg.src = user.photoURL || "";
        avatarImg.style.display = "block";
      } else {
        avatarImg.style.display = "none";
      }
    }
  });
});

/* ----------------------------- DOM ELEMENTS ------------------------------ */

const grid = document.getElementById("galleryGrid");
const selectDisplay = document.getElementById("selectDisplay");
const selectOptions = document.getElementById("selectOptions");
const loadMoreBtn = document.getElementById("loadMoreBtn");
const errorMsg = document.getElementById("errorMsg");

const addBtn = document.getElementById("addBtn");
const overlay = document.getElementById("overlay");
const cancelBtn = document.getElementById("cancelBtn");

const fileInput = document.getElementById("fileInput");
const cropArea = document.getElementById("cropArea");
const cropImg  = document.getElementById("cropImg");
const cropBtn  = document.getElementById("cropBtn");
const saveBtn  = document.getElementById("saveBtn");
const catInput = document.getElementById("catInput");
const subInput = document.getElementById("subInput");

const previewBackdrop = document.getElementById("galleryPreview");
const previewImg = document.getElementById("galleryPreviewImg");
const closePreviewBtn = document.getElementById("closePreviewBtn");

let cropper = null;
let currentUser = null;
let currentCategory = "all";

let lastVisible = null;        // For pagination
const PAGE_LIMIT = 20;         // Load 20 items per page

/* ----------------------------- CATEGORY DROPDOWN ------------------------------ */

selectDisplay.onclick = ()=> selectOptions.classList.toggle("show");
selectOptions.querySelectorAll("div").forEach(opt=>{
  opt.onclick = ()=>{
    currentCategory = opt.dataset.val;
    selectDisplay.textContent = opt.textContent + " â–¼";
    selectOptions.classList.remove("show");
    loadGallery(true);
  };
});

/* ----------------------------- OPEN ADD PHOTO MODAL ------------------------------ */
addBtn.onclick = ()=>{
  overlay.classList.add("show");
  overlay.setAttribute("aria-hidden", "false");
  fileInput.value = "";
  subInput.value = "";
  cropArea.style.display = "none";
  cropBtn.style.display = "none";
  cropper && cropper.destroy();
};

/* CLOSE MODAL */
cancelBtn.onclick = ()=> {
  overlay.classList.remove("show");
  overlay.setAttribute("aria-hidden", "true");
};

/* CLOSE MODAL WHEN CLICK OUTSIDE */
overlay.onclick = (e)=>{
  if(e.target === overlay){
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden", "true");
  }
};

/* ----------------------------- GALLERY LOADER ------------------------------ */

async function loadGallery(reset = false){
  try{
    if(reset){
      grid.innerHTML = "";
      lastVisible = null;
    }

    errorMsg.textContent = "Loading...";

    // build constraints
    const constraints = [];
    if(currentCategory !== "all"){
      constraints.push(where("category","==",currentCategory));
    }
    constraints.push(orderBy("createdAt","desc"));
    constraints.push(limit(PAGE_LIMIT));
    if(lastVisible) constraints.push(startAfter(lastVisible));

    const q = query(collection(db,"gallery"), ...constraints);

    const snap = await getDocs(q);

    if(snap.empty && reset){
      grid.innerHTML = "<p style='color:#ccc'>No images found.</p>";
      loadMoreBtn.style.display = "none";
      errorMsg.textContent = "";
      return;
    }

    snap.forEach(docSnap=>{
      const d = docSnap.data();

      const card = document.createElement("div");
      card.className = "card";

      const thumb = document.createElement("div");
      thumb.className = "thumb";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = d.imageUrl || d.url || "";
      img.alt = d.subtitle || "photo";
      img.onload = ()=> img.classList.add("loaded");

      // NOTE: do NOT attach click here; use delegated listener on grid for performance
      thumb.appendChild(img);
      card.appendChild(thumb);

      card.insertAdjacentHTML("beforeend", `
        <div class="meta">
          <span class="category">${escapeHtml(d.category||"")}</span>
          <p>${escapeHtml(d.subtitle||"")}</p>
        </div>
      `);

      // add delete button only for admin (we'll show/hide based on currentUser)
      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.textContent = "ðŸ—‘ Delete";
      delBtn.dataset.id = docSnap.id;
      delBtn.style.display = (currentUser && currentUser.uid === ADMIN_UID) ? "inline-block" : "none";
      // stop propagation so clicking delete won't open preview
      delBtn.addEventListener("click", async (ev)=>{
        ev.stopPropagation();
        if(!confirm("Delete photo?")) return;
        try{
          await deleteDoc(doc(db,"gallery",docSnap.id));
          loadGallery(true);
        }catch(err){
          console.error("delete gallery err", err);
          alert("Gagal hapus: "+(err.message||err));
        }
      });
      card.appendChild(delBtn);

      grid.appendChild(card);
    });

    lastVisible = snap.docs[snap.docs.length - 1];

    loadMoreBtn.style.display = snap.size < PAGE_LIMIT ? "none" : "block";
    errorMsg.textContent = "";

  } catch(err){
    console.error("Gallery load error:", err);
    errorMsg.textContent = "Failed to load gallery.";
  }
}

/* LOAD MORE */
loadMoreBtn.onclick = ()=> loadGallery(false);

/* ----------------------------- CROPPER HANDLER ------------------------------ */
fileInput.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = ()=>{
    cropImg.src = reader.result;
    cropArea.style.display = "block";
    cropBtn.style.display = "inline-block";

    cropper && cropper.destroy();
    cropper = new Cropper(cropImg,{ aspectRatio:16/9, viewMode:1, autoCropArea:1 });
  };
  reader.readAsDataURL(file);
};

cropBtn.onclick = ()=>{
  const canvas = cropper.getCroppedCanvas({ width:1600, height:900 });
  cropImg.src = canvas.toDataURL("image/jpeg",0.9);
  cropBtn.style.display = "none";
};

/* ----------------------------- GITHUB UPLOAD ------------------------------ */

function safeFileName(name){
  return name.replace(/[^a-z0-9\-\_\.]/gi,'_').replace(/\s+/g,'_').slice(0,120);
}

async function getGhTokenPrompt(){
  let token = localStorage.getItem('gh_token');
  if(token) return token;

  token = prompt("Enter GitHub Token (repo scope):");
  if(token){
    token = token.trim();
    localStorage.setItem('gh_token', token);
    return token;
  }
  return null;
}

async function uploadToGitHub(file){
  const token = await getGhTokenPrompt();
  if(!token) throw new Error("Token required.");

  const base64 = await new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result.split(",")[1]);
    r.onerror = rej;
    r.readAsDataURL(file);
  });

  const ts = Date.now();
  const fname = safeFileName(file.name || `img_${ts}.jpg`);
  const path = `gallery/${ts}_${fname}`;

  const apiUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`;

  const body = {
    message: "upload gallery",
    content: base64,
    branch: GITHUB_BRANCH
  };

  const resp = await fetch(apiUrl,{
    method:"PUT",
    headers:{
      "Authorization":`Bearer ${token}`,
      "Content-Type":"application/json"
    },
    body:JSON.stringify(body)
  });

  if(!resp.ok){
    const txt = await resp.text();
    console.error("FULL GITHUB ERROR:", txt);
    localStorage.removeItem("gh_token");
    throw new Error("GitHub upload failed: " + txt);
  }

  return `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${path}`;
}

/* ----------------------------- SAVE PHOTO ------------------------------ */

saveBtn.onclick = async()=>{
  if(!cropImg.src) return alert("Upload image first!");

  saveBtn.disabled = true;
  saveBtn.textContent = "Uploading...";

  try{
    const blob = await (await fetch(cropImg.src)).blob();
    const url = await uploadToGitHub(blob);

    await addDoc(collection(db,"gallery"),{
      imageUrl:url,
      subtitle:subInput.value,
      category:catInput.value,
      createdAt:serverTimestamp()
    });

    alert("Photo added!");
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden", "true");
    fileInput.value = "";
    cropArea.style.display = "none";
    cropBtn.style.display = "none";
    saveBtn.textContent = "Upload";

    loadGallery(true);

  } catch(err){
    alert("Upload failed: " + err.message);
  } finally {
    saveBtn.disabled = false;
  }
};

/* ----------------------------- AUTH ------------------------------ */

onAuthStateChanged(auth, user=>{
  currentUser = user;
  addBtn.style.display = (user && user.uid === ADMIN_UID) ? "inline-block" : "none";

  // Update header
  const signText = document.getElementById("signText");
  const avatarImg = document.getElementById("avatarImg");
  const signBtn = document.getElementById("signBtn");

  if(signText) signText.textContent = user ? "Logout" : "Sign In";
  if(avatarImg){
    avatarImg.style.display = user ? "block" : "none";
    if(user) avatarImg.src = user.photoURL;
  }

  if(signBtn){
    signBtn.onclick = async()=>{
      if(auth.currentUser) await signOut(auth);
      else await signInWithPopup(auth, provider);
    };
  }

  // show delete buttons if grid already rendered
  document.querySelectorAll(".delete-btn").forEach(b=>{
    b.style.display = (user && user.uid === ADMIN_UID) ? "inline-block" : "none";
  });
});

/* ----------------------------- INIT ------------------------------ */

window.addEventListener("header-ready", ()=> loadGallery(true));

document.addEventListener("DOMContentLoaded", ()=>{
  if(window._headerReady) loadGallery(true);
});

/* === GALLERY PREVIEW (delegated + safe) === */

grid.addEventListener("click", (e)=>{
  // 1) If clicked delete button: handler already attached per-button (we stopPropagation there)
  const del = e.target.closest('.delete-btn');
  if(del) return; // delete handled by its own listener

  // 2) If clicked image inside a .thumb -> open preview
  const img = e.target.closest('.thumb img');
  if(img){
    openPreview(img.src);
  }
});

// open preview
function openPreview(src) {
  previewImg.src = src;
  previewBackdrop.style.display = "flex";
  previewBackdrop.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";
}

// close preview
function closePreview() {
  previewBackdrop.style.display = "none";
  previewBackdrop.setAttribute("aria-hidden","true");
  previewImg.src = "";
  document.body.style.overflow = "";
}

closePreviewBtn.onclick = closePreview;
previewBackdrop.onclick = (e) => {
  if (e.target === previewBackdrop) closePreview();
};

/* ----------------------------- UTIL ------------------------------ */
function escapeHtml(s){
  return String(s||"")
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

  </script>

</body>
</html>