<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MadridForID | Gallery</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

  <style>
    :root {
      --gold:#ffd700;--navy:#001b4d;--dark:#0b1d3a;--red:#e63946;--white:#fff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      font-family:"Poppins",sans-serif;
      background:linear-gradient(180deg,var(--dark),#0a1a38);
      color:var(--white);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }
    main{flex:1;width:100%;max-width:1100px;margin:auto;padding:20px}
    .top-row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;margin-bottom:14px;gap:12px}
    .btn{background:var(--gold);color:#000;border:0;padding:8px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:2px solid var(--gold);color:var(--gold)}
    .category-select{position:relative}
    .select-display{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:6px 12px;cursor:pointer;color:#fff;min-width:180px;display:flex;justify-content:space-between;align-items:center}
    .select-options{position:absolute;top:105%;left:0;width:100%;background:#fff;color:#000;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);display:none;flex-direction:column;z-index:10}
    .select-options.show{display:flex}
    .select-options div{padding:8px 10px;cursor:pointer}
    .select-options div:hover{background:var(--gold);color:#000;font-weight:600}
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-top:20px}
    .card{background:rgba(255,255,255,0.05);border-radius:12px;overflow:hidden;transition:transform .18s;position:relative}
    .card:hover{transform:translateY(-5px)}
    .thumb{position:relative;padding-top:56.25%;overflow:hidden;background:#111}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transition:opacity .4s ease;opacity:0}
    .thumb img.loaded{opacity:1}
    .meta{text-align:center;padding:10px}
    .category{display:inline-block;background:var(--gold);color:#000;padding:4px 10px;border-radius:999px;font-weight:700;font-size:.8rem}
    .delete-btn{background:var(--red);border:0;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;margin-top:6px}
    footer{background:var(--navy);text-align:center;padding:15px;font-size:.9rem;margin-top:auto}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;justify-content:center;align-items:center;z-index:1500}
    .overlay.show{display:flex}
    .form-card{background:#fff;color:#000;border-radius:12px;padding:20px;width:90%;max-width:600px}
    .form-group{margin-bottom:12px}
    .form-group label{display:block;font-weight:600;margin-bottom:6px}
    .form-group input{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px}
    #cropArea{display:none;margin-top:10px;max-height:350px;overflow:hidden;border-radius:8px}
    #cropArea img{width:100%;display:block}
  </style>
</head>

<body>
  <!-- ‚úÖ HEADER INCLUDE -->
  <div id="include-header"></div>
  <script>
  (async()=>{
    try{
      const res = await fetch("header.html?cb="+Date.now());
      const html = await res.text();
      const headerContainer = document.getElementById("include-header");
      headerContainer.innerHTML = html;

      // jalankan ulang semua script header (termasuk module)
      headerContainer.querySelectorAll("script").forEach((oldScript)=>{
        const newScript = document.createElement("script");
        if(oldScript.type) newScript.type = oldScript.type;
        if(oldScript.src) newScript.src = oldScript.src;
        else newScript.textContent = oldScript.textContent;
        document.body.appendChild(newScript);
      });
      console.log("‚úÖ Header loaded and scripts active");
    }catch(e){console.error("‚ùå Header load failed:", e);}
  })();
  </script>
  <!-- ‚úÖ /HEADER INCLUDE -->

  <main>
    <div class="top-row">
      <h2>üì∏ Gallery</h2>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="category-select">
          <div id="selectDisplay" class="select-display">All categories ‚ñº</div>
          <div id="selectOptions" class="select-options">
            <div data-val="all">All categories</div>
            <div data-val="Matchday">Matchday</div>
            <div data-val="Training">Training</div>
            <div data-val="Press Conference">Press Conference</div>
            <div data-val="Celebration">Celebration</div>
            <div data-val="Other">Other</div>
          </div>
        </div>
        <button id="addBtn" class="btn" style="display:none;">Ôºã Add Photo</button>
      </div>
    </div>

    <div id="galleryGrid" class="gallery-grid"></div>
  </main>

  <!-- Overlay Upload -->
  <div id="overlay" class="overlay">
    <div class="form-card">
      <h3 style="text-align:center;margin-bottom:10px;">Ôºã Add Photo</h3>
      <div class="form-group">
        <label>Category</label>
        <select id="catInput" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc">
          <option value="Matchday">Matchday</option>
          <option value="Training">Training</option>
          <option value="Press Conference">Press Conference</option>
          <option value="Celebration">Celebration</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Subtitle</label>
        <input id="subInput" placeholder="e.g. Jude Bellingham goal" />
      </div>
      <div class="form-group">
        <label>Upload Image</label>
        <input id="fileInput" type="file" accept="image/*" />
        <div id="cropArea"><img id="cropImg"></div>
        <button id="cropBtn" class="btn" style="display:none;margin-top:8px;">Crop (16:9)</button>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
        <button id="saveBtn" class="btn">Upload</button>
        <button onclick="closeOverlay()" class="btn ghost">Cancel</button>
      </div>
    </div>
  </div>

  <footer>¬© 2025 MadridForID | Real Madrid Indonesia Fanbase</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, where, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey:"AIzaSyA18AEH3-hByOQ7g9i3OJCJLzt4HDIJbpc",
      authDomain:"madridforid-web.firebaseapp.com",
      projectId:"madridforid-web",
      storageBucket:"madridforid-web.appspot.com",
      messagingSenderId:"882098167537",
      appId:"1:882098167537:web:acf50819e9c81adaad1350"
    };

    const ADMIN_UID="T9MBugPPYLQ4HVu6uLBV3kEck3C2";
    const app=initializeApp(firebaseConfig);
    const db=getFirestore(app);
    const auth=getAuth(app);

    const grid=document.getElementById("galleryGrid");
    const selectDisplay=document.getElementById("selectDisplay");
    const selectOptions=document.getElementById("selectOptions");
    const addBtn=document.getElementById("addBtn");
    const overlay=document.getElementById("overlay");
    const catInput=document.getElementById("catInput");
    const subInput=document.getElementById("subInput");
    const fileInput=document.getElementById("fileInput");
    const cropArea=document.getElementById("cropArea");
    const cropImg=document.getElementById("cropImg");
    const cropBtn=document.getElementById("cropBtn");
    const saveBtn=document.getElementById("saveBtn");
    let cropper,currentUser=null;

    selectDisplay.onclick=()=>selectOptions.classList.toggle("show");
    selectOptions.querySelectorAll("div").forEach(opt=>{
      opt.onclick=()=>{
        selectDisplay.textContent=opt.textContent+" ‚ñº";
        selectOptions.classList.remove("show");
        loadGallery(opt.dataset.val);
      };
    });

    async function loadGallery(cat="all"){
      grid.innerHTML="<p style='color:#ccc;'>Loading...</p>";
      let q=(cat!=="all")?query(collection(db,"gallery"),where("category","==",cat),orderBy("createdAt","desc")):query(collection(db,"gallery"),orderBy("createdAt","desc"));
      const snap=await getDocs(q);
      grid.innerHTML="";
      if(snap.empty){grid.innerHTML="<p style='color:#bbb;'>No images found.</p>";return;}
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const div=document.createElement("div");
        div.className="card";
        const img=document.createElement("img");
        img.src=d.imageUrl;
        img.loading="lazy";
        img.onload=()=>img.classList.add("loaded");
        div.innerHTML=`
          <div class='thumb'></div>
          <div class='meta'>
            <span class='category'>${d.category||""}</span>
            <p>${d.subtitle||""}</p>
          </div>`;
        div.querySelector(".thumb").appendChild(img);
        if(currentUser && currentUser.uid===ADMIN_UID){
          const del=document.createElement("button");
          del.textContent="üóë Delete";
          del.className="delete-btn";
          del.onclick=async()=>{if(confirm("Delete photo?")){await deleteDoc(doc(db,"gallery",docSnap.id));loadGallery(cat);}};
          div.appendChild(del);
        }
        grid.appendChild(div);
      });
    }

    onAuthStateChanged(auth,u=>{currentUser=u;if(u&&u.uid===ADMIN_UID)addBtn.style.display="inline-block";});
    addBtn.onclick=()=>overlay.classList.add("show");
    window.closeOverlay=()=>overlay.classList.remove("show");

    fileInput.onchange=e=>{
      const f=e.target.files[0];
      if(!f)return;
      const r=new FileReader();
      r.onload=()=>{
        cropImg.src=r.result;
        cropArea.style.display="block";
        cropBtn.style.display="inline-block";
        cropper&&cropper.destroy();
        cropper=new Cropper(cropImg,{aspectRatio:16/9,viewMode:1});
      };
      r.readAsDataURL(f);
    };
    cropBtn.onclick=()=>{
      const canvas=cropper.getCroppedCanvas({width:1280,height:720});
      cropImg.src=canvas.toDataURL("image/jpeg");
      cropBtn.style.display="none";
    };
    saveBtn.onclick=async()=>{
      if(!cropImg.src){alert("Please upload an image!");return;}
      await addDoc(collection(db,"gallery"),{imageUrl:cropImg.src,subtitle:subInput.value,category:catInput.value,createdAt:serverTimestamp()});
      alert("Photo added!");overlay.classList.remove("show");loadGallery();
    };

    loadGallery();
  </script>
</body>
</html>