<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MadridForID | News</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>

<style>
:root {
  --gold: #ffd700;
  --navy: #0b1d3a;
  --gray: #1a2238;
  --white: #ffffff;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; min-height: 100%; overflow-x: hidden; }
body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(180deg, #0b1d3a 0%, #09152e 100%);
  color: var(--white);
  display: flex;
  flex-direction: column;
}

/* MAIN */
main {
  flex: 1;
  width: 100%;
  max-width: 1000px;
  margin: auto;
  padding: 20px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 3px solid var(--gold);
  margin-bottom: 15px;
}

.section-header h2 { font-size: 1.4rem; font-weight: 700; }

#createNewsBtn {
  display: none;
  background: var(--gold);
  color: var(--navy);
  padding: 6px 12px;
  font-weight: 700;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
#createNewsBtn:hover { opacity: .8; }

/* NEWS CARD */
.news-card {
  background: var(--gray);
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 22px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
}

.news-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
.news-card h3 { margin: 10px; }
.news-card p { margin: 0 10px 10px; color: #ccc; }

.read-btn {
  background: var(--gold);
  color: var(--navy);
  font-weight: bold;
  border-radius: 6px;
  padding: 6px 10px;
  text-decoration: none;
  margin: 0 10px 12px;
  display: inline-block;
}

.card-footer {
  padding: 10px;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  color: #bbb;
}

.delete-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: red;
  color: #fff;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
}

/* FOOTER */
footer {
  background: var(--navy);
  padding: 18px;
  text-align: center;
  margin-top: auto;
}

/* POPUP */
.popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(6px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
}
.popup.active { display: flex; }

.popup form {
  background: var(--gray);
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.popup input, .popup textarea {
  background: #10254d;
  border: none;
  padding: 8px;
  color: #fff;
  border-radius: 6px;
}
#imgPreview { max-height: 220px; width: 100%; border-radius: 6px; display: none; }

.spinner {
  width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>

<body>

<!-- HEADER LOADER -->
<div id="include-header"></div>
<script>
(async()=>{
  const container = document.getElementById("include-header");
  const html = await (await fetch("header.html?cb=" + Date.now())).text();
  container.innerHTML = html;

  // Re-run script header sebagai module
  container.querySelectorAll("script").forEach(old=>{
    const s=document.createElement("script");
    s.type = "module";
    if(old.src) s.src = old.src;
    else s.textContent = old.textContent;
    document.body.appendChild(s);
  });
})();
</script>

<main>
  <div class="section-header">
    <h2>üì∞ Latest News</h2>
    <button id="createNewsBtn">‚ûï Create News</button>
  </div>

  <div id="newsContainer"></div>
</main>

<footer>¬© 2025 MadridForID | Real Madrid Indonesian Fanbase</footer>

<!-- POPUP -->
<div class="popup" id="popupForm">
  <form id="createForm">
    <h3>Create News</h3>
    <input type="text" id="title" placeholder="Title" required>
    <textarea id="summary" placeholder="Summary" required></textarea>
    <textarea id="content" placeholder="Content" required></textarea>
    <input type="file" id="imageFile" accept="image/*" required>
    <img id="imgPreview">
    <button id="uploadBtn" type="submit">Upload & Save</button>
  </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, deleteDoc,
  doc, orderBy, query, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA18AEH3-hByOQ7g9i3OJCJLzt4HDIJbpc",
  authDomain: "madridforid-web.firebaseapp.com",
  projectId: "madridforid-web",
  storageBucket: "madridforid-web.appspot.com",
  messagingSenderId: "882098167537",
  appId: "1:882098167537:web:acf50819e9c81adaad1350"
};

const ADMIN_UID = "T9MBugPPYLQ4HVu6uLBV3kEck3C2";
const IMGBB_API_KEY = "c438ddf1b0de692e084414e335436ec6";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const createBtn = document.getElementById("createNewsBtn");
const popup = document.getElementById("popupForm");
const form = document.getElementById("createForm");
const fileInput = document.getElementById("imageFile");
const imgPreview = document.getElementById("imgPreview");
const uploadBtn = document.getElementById("uploadBtn");
const newsContainer = document.getElementById("newsContainer");

let currentUser = null;
let cropper = null;

onAuthStateChanged(auth, user => {
  currentUser = user;
  createBtn.style.display = (user && user.uid === ADMIN_UID) ? "block" : "none";
  loadNews();
});

fileInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    imgPreview.src = reader.result;
    imgPreview.style.display = "block";

    cropper?.destroy();
    cropper = new Cropper(imgPreview, { aspectRatio: 16/9 });
  };
  reader.readAsDataURL(file);
});

createBtn.onclick = () => popup.classList.add("active");
popup.onclick = (e)=>{ if(e.target===popup) popup.classList.remove("active"); };

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentUser || currentUser.uid !== ADMIN_UID)
    return alert("Admin only!");

  uploadBtn.disabled = true;
  uploadBtn.innerHTML = `<div class='spinner'></div> Uploading...`;

  cropper.getCroppedCanvas({ width:900, height:506 }).toBlob(async (blob)=>{

    const fd = new FormData();
    fd.append("image", blob);

    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{
      method:"POST",
      body:fd
    });

    const data = await res.json();
    const imgUrl = data.data.url;

    await addDoc(collection(db,"news"),{
      title: title.value,
      summary: summary.value,
      content: content.value,
      image: imgUrl,
      likes: 0,
      likedBy: [],
      comments: [],
      createdAt: serverTimestamp()
    });

    alert("News Added!");
    popup.classList.remove("active");
    form.reset();
    imgPreview.style.display = "none";
    uploadBtn.disabled = false;
    uploadBtn.innerHTML = "Upload & Save";

    loadNews();
  });
});

async function loadNews(){
  const q = query(collection(db,"news"), orderBy("createdAt","desc"));
  const snap = await getDocs(q);

  newsContainer.innerHTML = "";

  snap.forEach(docSnap=>{
    const d = docSnap.data();
    const isAdmin = currentUser && currentUser.uid === ADMIN_UID;

    newsContainer.innerHTML += `
      <div class="news-card">
        <img src="${d.image}">
        <h3>${d.title}</h3>
        <p>${d.summary}</p>

        <a href="news-detail.html?id=${docSnap.id}" class="read-btn">Read More</a>

        <div class="card-footer">
          <span>üí¨ ${d.comments?.length || 0}</span>
          <span>‚ù§Ô∏è ${d.likes || 0}</span>
        </div>

        ${isAdmin ?
          `<button class="delete-btn" onclick="deleteNews('${docSnap.id}')">üóëÔ∏è</button>` 
        : ""}
      </div>
    `;
  });
}

window.deleteNews = async function(id){
  if(!confirm("Delete news?")) return;
  await deleteDoc(doc(db,"news",id));
  loadNews();
}
</script>
</body>
</html>